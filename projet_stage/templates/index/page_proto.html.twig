{% extends 'base.html.twig' %}

{% block title %}Hello IndexController!{% endblock %}

{% block body %}
{# redirction si pas contrib ou admin #}
{% if is_granted('ROLE_ADMIN') or is_granted('ROLE_CONTRIBUTOR') %}
    <style>
        .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
        .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }
    </style>

    <div class="example-wrapper">
        <h3>PAGE PROTO</h3>

        le {{ proto.datetime|date('d/m/Y H:i') }}
        <br>
        <h1>{{ proto.titre| raw }}</h1>
        <br>
        {{ proto.contenue| raw }}
        <br>

        {% for img in images %}
            <img src="data:image/png;base64, {{ img.image }}" style="max-width:600px;max-height:600px">
            <br><br>
        {% endfor %}

        <br><br><br>

        {% if listecontrib %}
        {# contributeur #}
            <h3>Liste des contributeurs :</h3>
            {% set contributeurProjet = false %}
            {% for contrib in listecontrib %}
                <a href="pageuser{{ contrib.user.id }}">{{ contrib.user.name }}</a>

                {% set testimage = contrib.user.avatar %}

                {% if testimage %}
                    <img src="data:image/png;base64,{{ testimage }}" width='60px' height='60px' />
                {% endif %}

                <br><br>
                {# rejoindre le projet si pas deja dedant #}
                {% if contrib.user == app.user %}
                    {% set contributeurProjet = true %}
                {% endif %}
            {% endfor %}
            {% if contributeurProjet == false %}
                devenir contributeur sur le projet : <a href="newcontrib{{ proto.id }}">{{ proto.titre| raw }}</a>
            {% endif %}
        {% endif %}

        <br><br><br>

        {# commentaire #}
        <h3>Commentaire :</h3>
        {% for com in comments %}
            {% if com.envoyer.roles[0] == 'ROLE_ADMIN'%}
                {% set role = 'Admin' %}
            {% elseif com.envoyer.roles[0] == 'ROLE_CONTRIBUTOR'%} 
                {% set role = 'Contributeur' %}
            {% else %}
                {% set role = 'Utilisateur' %}
            {% endif %}

            <div id="Com{{ com.id }}">
                le {{ com.datetime|date('d/m/Y H:i') }} {{ role }} <a href="pageuser{{ com.envoyer.id }}">{{ com.envoyer.name }}</a> dit : {{ com.contenue }}
            </div>

            <form id="UpdateCom{{ com.id }}" action="updatecom{{ com.id }}" style="display: none">
                <textarea name="textComment" class="form-control" rows="3" >{{ com.contenue }}</textarea>
                
                <br><button class="btn btn-light">Valider modification</button> 
            </form>
            
            {% if app.user %}
                {% if is_granted('ROLE_ADMIN') or com.envoyer == app.user %}
                    <a href="deletecom{{ com.id }}">Supprimer</a>

                    <button id="btnUpdateCom{{ com.id }}" onclick="showUpdateCom({{ com.id }})">Modifier</button> 
                {% endif %}
            {% endif %}
            <br><br>
        {% endfor %}

        {% if app.user %}
            <form id="formCom" action="commentaire" style="display: none">
                <textarea name="textComment" class="form-control" rows="3" placeholder="plouf"></textarea>
                
                <input type="hidden" name="type" value="proto"> 
                <input type="hidden" name="pageid" value="{{ proto.id }}"> 
                
                <br><button class="btn btn-light">envoyer</button> 
            </form>   
            
            <button id="btnFormCom" class="btn btn-light" onclick="showFormCom()">laisser un commentaire</button> 
        {% endif %} 

    </div>
{% else %}
    <script>
        window.location.href = 'listeblog';
    </script>
{% endif %}
{% endblock %}

{% block javascripts %}
    <script>
        var visible=false;
        var visible2=false;
        
        function showFormCom(){
            if (visible==false){
                document.getElementById("formCom").style.display = "block";
                document.getElementById('btnFormCom').innerHTML = "Fermer";
                visible=true;
            }else{
                document.getElementById("formCom").style.display = "none";
                document.getElementById("btnFormCom").innerHTML = "laisser un commentaire";
                visible=false;
            }
        }

        function showUpdateCom($id){
            if (visible2==false){
                document.getElementById("UpdateCom"+$id).style.display = "block";
                document.getElementById("Com"+$id).style.display = "none";
                document.getElementById('btnUpdateCom'+$id).innerHTML = "Fermer";
                visible2=true;
            }else{
                document.getElementById("UpdateCom"+$id).style.display = "none";
                document.getElementById("Com"+$id).style.display = "block";
                document.getElementById('btnUpdateCom'+$id).innerHTML = "Modifier";
                visible2=false;
            }
        }
    </script>
{% endblock %}
